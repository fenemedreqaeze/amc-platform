<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cr√©ateur d'examen</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #1f2937;
      --text: #e5e7eb;
      --soft: #9ca3af;
      --primary: #60a5fa;
      --primary-600: #2563eb;
      --success: #22c55e;
      --danger: #ef4444;
      --danger-600: #dc2626;
      --shadow: rgba(0,0,0,.35);
      --maths: #e74c3c;
      --french: #3498db;
      --english: #9b59b6;
      --history: #e67e22;
      --geography: #27ae60;
      --science: #f39c12;
      --other: #95a5a6;
    }

    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
    .container { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 28px; font-weight: 700; margin: 0 0 20px; }
    h3 { margin: 0 0 12px; font-size: 18px; }

    .exam-header {
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px var(--shadow);
    }

    .exam-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .exam-meta label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--soft);
    }

    select, textarea, input[type="text"], input[type="number"] {
      width: 100%;
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      margin-bottom: 12px;
    }

    .question-card {
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: 14px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 6px 20px var(--shadow);
    }

    .subject-maths { border-left: 4px solid var(--maths); }
    .subject-french { border-left: 4px solid var(--french); }
    .subject-english { border-left: 4px solid var(--english); }
    .subject-history { border-left: 4px solid var(--history); }
    .subject-geography { border-left: 4px solid var(--geography); }
    .subject-science { border-left: 4px solid var(--science); }
    .subject-other { border-left: 4px solid var(--other); }

    .answer-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      padding: 10px;
      background: #0b1220;
      border: 1px solid var(--muted);
      border-radius: 10px;
    }

    .answer-row.correct-answer { border-color: var(--primary); box-shadow: inset 0 0 0 1px rgba(96,165,250,.35); }

    .answer-row input[type="text"] {
      background: transparent;
      border: none;
      border-left: 1px solid var(--muted);
      padding: 8px 10px;
    }

    .btn-primary, .btn-success, .btn-danger {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      transition: transform .04s ease;
      margin: 5px;
    }

    .btn-primary { background: var(--primary-600); }
    .btn-success { background: var(--success); color: #052e0f; }
    .btn-danger { background: var(--danger); }

    .btn-primary:active, .btn-success:active, .btn-danger:active { transform: translateY(1px); }

    .actions { text-align: center; margin-top: 24px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .sub-actions { display: flex; gap: 8px; margin-top: 10px; }
    .note { color: var(--soft); font-size: 13px; margin-top: 8px; }

    .download-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cr√©ateur d'examen</h1>

    <div class="exam-header">
      <input type="text" id="exam-title" placeholder="Titre de l'examen" style="font-size: 1.3em; font-weight: bold; background: transparent; border: none; color: var(--text); outline: none; width: 100%;">
      <textarea id="exam-description" placeholder="Description de l'examen..." rows="2" style="margin-top: 10px;"></textarea>
      
      <div class="exam-meta">
        <div>
          <label for="subject-select">üìö Mati√®re</label>
          <select id="subject-select">
            <option value="maths">üìê Math√©matiques</option>
            <option value="french">üìñ Fran√ßais</option>
            <option value="english">üî§ Anglais</option>
            <option value="history">üèõÔ∏è Histoire</option>
            <option value="geography">üåç G√©ographie</option>
            <option value="science">üî¨ Sciences</option>
            <option value="other">üìö Autre mati√®re</option>
          </select>
        </div>
        <div>
          <label for="exam-difficulty">üéØ Niveau</label>
          <select id="exam-difficulty">
            <option value="easy">üü¢ Facile</option>
            <option value="medium">üü° Moyen</option>
            <option value="hard">üî¥ Difficile</option>
          </select>
        </div>
      </div>
    </div>

    <div id="questions-container"></div>

    <div class="actions">
      <button type="button" class="btn-success" onclick="addQuestion()">‚ûï Ajouter une Question</button>
      <button type="button" class="btn-primary" onclick="saveExam()">üíæ Sauvegarder l'Examen</button>
      <button type="button" class="btn-primary" onclick="goBack()">‚Üê Retour √† l'accueil</button>
    </div>

    <div class="exam-header" style="margin-top: 30px;">
      <h3>üîÑ G√©n√©ration de fichiers</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
        <div>
          <label for="n-copies">Nombre de copies</label>
          <input type="number" id="n-copies" value="1" min="1">
        </div>
        <div>
          <label for="project-id">ID Projet</label>
          <input type="text" id="project-id" readonly style="color: var(--soft);">
        </div>
      </div>

      <div class="actions" style="margin-top: 20px;">
        <button type="button" class="btn-success" onclick="generateRealPDF()">üéØ G√©n√©rer PDF</button>
        <button type="button" class="btn-primary" onclick="downloadLaTeX()">üìÑ T√©l√©charger .tex</button>
      </div>

      <div id="amc-status" style="margin-top: 15px; padding: 12px; border-radius: 10px; background: #0b1220; border: 1px solid var(--muted);"></div>

      <div id="download-buttons" class="download-buttons" style="display: none;">
        <!-- Les boutons de t√©l√©chargement appara√Ætront ici -->
      </div>
    </div>

    <p class="note">Astuce : marque la bonne r√©ponse en cochant le bouton radio correspondant.</p>
  </div>

  <script>
    let questionCount = 0;
    let currentSubject = 'maths';
    let currentProjectId = null;
    let currentLaTeXContent = '';

    function getCurrentProjectId() {
      return localStorage.getItem('currentProjectId');
    }

    document.addEventListener('DOMContentLoaded', function() {
      const projectId = getCurrentProjectId();
      if (projectId) {
        currentProjectId = projectId;
        document.getElementById('project-id').value = projectId;
        showAMCStatus('‚úÖ Projet charg√©: ' + projectId, 'success');
      } else {
        showAMCStatus('‚ùå Aucun projet actif - Revenez √† l\'accueil', 'error');
      }
      
      addQuestion();
      
      document.getElementById('subject-select').addEventListener('change', function(e) {
        currentSubject = e.target.value;
        updateQuestionStyles();
      });
    });

    function updateQuestionStyles() {
      document.querySelectorAll('.question-card').forEach(card => {
        card.classList.remove('subject-maths', 'subject-french', 'subject-english', 'subject-history', 'subject-geography', 'subject-science', 'subject-other');
        card.classList.add('subject-' + currentSubject);
      });
    }

    function addQuestion() {
      questionCount++;
      const questionsContainer = document.getElementById('questions-container');

      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-card subject-' + currentSubject;
      questionDiv.id = 'question-' + questionCount;
      questionDiv.innerHTML = `
        <h3>Question ${questionCount}</h3>
        <textarea placeholder="√ânonc√© de la question..." rows="3"></textarea>

        <div class="answer-row correct-answer">
          <input type="radio" name="correct-${questionCount}" checked>
          <input type="text" placeholder="R√©ponse correcte" style="flex: 1;">
          <button type="button" class="btn-danger answer-remove">‚úï</button>
        </div>

        <div class="answer-row">
          <input type="radio" name="correct-${questionCount}">
          <input type="text" placeholder="Mauvaise r√©ponse" style="flex: 1;">
          <button type="button" class="btn-danger answer-remove">‚úï</button>
        </div>

        <div class="sub-actions">
          <button type="button" class="btn-success add-answer-btn" data-id="${questionCount}">‚ûï Ajouter une r√©ponse</button>
          <button type="button" class="btn-danger remove-question-btn" data-id="${questionCount}">üóëÔ∏è Supprimer cette question</button>
        </div>
      `;

      questionsContainer.appendChild(questionDiv);

      questionDiv.querySelector('.add-answer-btn').addEventListener('click', function (e) {
        e.stopPropagation();
        addAnswer(this.getAttribute('data-id'));
      });

      questionDiv.querySelector('.remove-question-btn').addEventListener('click', function (e) {
        e.stopPropagation();
        removeQuestion(this.getAttribute('data-id'));
      });

      questionDiv.querySelectorAll('.answer-remove').forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.stopPropagation();
          this.parentElement.remove();
        });
      });

      questionDiv.querySelectorAll('input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          questionDiv.querySelectorAll('.answer-row').forEach(row => row.classList.remove('correct-answer'));
          r.closest('.answer-row').classList.add('correct-answer');
        });
      });
    }

    function addAnswer(questionId) {
      const question = document.getElementById('question-' + questionId);
      if (!question) return;

      const newAnswer = document.createElement('div');
      newAnswer.className = 'answer-row';
      newAnswer.innerHTML = `
        <input type="radio" name="correct-${questionId}">
        <input type="text" placeholder="Nouvelle r√©ponse" style="flex: 1;">
        <button type="button" class="btn-danger answer-remove">‚úï</button>
      `;

      newAnswer.querySelector('.answer-remove').addEventListener('click', function (e) {
        e.stopPropagation();
        this.parentElement.remove();
      });

      newAnswer.querySelector('input[type="radio"]').addEventListener('change', () => {
        question.querySelectorAll('.answer-row').forEach(row => row.classList.remove('correct-answer'));
        newAnswer.classList.add('correct-answer');
      });

      question.insertBefore(newAnswer, question.querySelector('.sub-actions'));
    }

    function removeQuestion(questionId) {
      const node = document.getElementById('question-' + questionId);
      if (node) node.remove();
    }

    function saveExam() {
      const subject = document.getElementById('subject-select');
      const difficulty = document.getElementById('exam-difficulty');
      const title = document.getElementById('exam-title').value || 'Sans titre';
      const subjectText = subject.options[subject.selectedIndex].text;
      const difficultyText = difficulty.options[difficulty.selectedIndex].text;
      
      alert('üéâ Examen "' + title + '" sauvegard√© !\nüìö Mati√®re: ' + subjectText + '\nüéØ Niveau: ' + difficultyText);
    }

    function goBack() {
      window.location.href = '/';
    }

    function generateLaTeX() {
      const title = document.getElementById('exam-title').value || 'Examen Sans Titre';
      const subject = document.getElementById('subject-select').options[document.getElementById('subject-select').selectedIndex].text;
      
      let latexContent = '\\documentclass[a4paper,11pt]{article}\n';
      latexContent += '\\usepackage[utf8]{inputenc}\n';
      latexContent += '\\usepackage[T1]{fontenc}\n';
      latexContent += '\\usepackage[francais]{babel}\n';
      latexContent += '\\usepackage{amsmath}\n';
      latexContent += '\\usepackage{amssymb}\n\n';
      latexContent += '\\title{' + title + '}\n';
      latexContent += '\\author{' + subject + '}\n';
      latexContent += '\\date{\\today}\n\n';
      latexContent += '\\begin{document}\n';
      latexContent += '\\maketitle\n\n';
      latexContent += '\\section*{Questions}\n\n';

      document.querySelectorAll('.question-card').forEach((qCard, index) => {
        const questionText = qCard.querySelector('textarea').value || 'Question ' + (index + 1);
        const answers = [];
        let correctAnswerIndex = -1;
        
        qCard.querySelectorAll('.answer-row').forEach((row, ansIndex) => {
          const answerText = row.querySelector('input[type="text"]').value || 'R√©ponse ' + (ansIndex + 1);
          const isCorrect = row.querySelector('input[type="radio"]').checked;
          answers.push(answerText);
          if (isCorrect) correctAnswerIndex = ansIndex;
        });

        if (answers.length > 0) {
          latexContent += '\\textbf{' + (index + 1) + '. ' + questionText + '}\n';
          latexContent += '\\begin{enumerate}\n';
          answers.forEach((answer, i) => {
            if (i === correctAnswerIndex) {
              latexContent += '\\item[‚úì] ' + answer + '\n';
            } else {
              latexContent += '\\item[ ] ' + answer + '\n';
            }
          });
          latexContent += '\\end{enumerate}\n\n';
        }
      });

      latexContent += '\\end{document}';
      currentLaTeXContent = latexContent;
      return latexContent;
    }

    // Fonction pour t√©l√©charger le fichier .tex
    function downloadLaTeX() {
      const latexContent = generateLaTeX();
      const title = document.getElementById('exam-title').value || 'examen';
      const filename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.tex';
      
      const blob = new Blob([latexContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showAMCStatus('‚úÖ Fichier .tex t√©l√©charg√© !', 'success');
    }

    async function generateRealPDF() {
      const projectId = getCurrentProjectId();
      if (!projectId) {
        showAMCStatus('‚ùå Aucun projet actif - Revenez √† l\'accueil', 'error');
        return;
      }

      try {
        showAMCStatus('üîÑ G√©n√©ration du LaTeX...', 'loading');
        const latexContent = generateLaTeX();
        
        console.log('LaTeX g√©n√©r√©:', latexContent);
        
        showAMCStatus('üì§ Upload du fichier...', 'loading');
        const formData = new FormData();
        const blob = new Blob([latexContent], { type: 'text/plain' });
        
        // CORRECTION : Utiliser test-exam.tex comme attendu par l'API
        formData.append('source', blob, 'test-exam.tex');
        
        const uploadResponse = await fetch('/api/projects/' + projectId + '/source', {
          method: 'POST',
          body: formData
        });
        
        const uploadResult = await uploadResponse.json();
        console.log('Upload result:', uploadResult);
        
        showAMCStatus('üîÑ Compilation PDF...', 'loading');
        const compileResponse = await fetch('/api/projects/' + projectId + '/compile', {
          method: 'POST'
        });
        
        const result = await compileResponse.json();
        console.log('Compile result:', result);
        
        if (result.pdf_created) {
          showAMCStatus('‚úÖ PDF g√©n√©r√© avec succ√®s !', 'success');
          showDownloadButtons(projectId);
        } else {
          showAMCStatus('‚ùå Erreur compilation: ' + (result.log || 'Unknown error'), 'error');
        }
        
      } catch (error) {
        console.error('Erreur compl√®te:', error);
        showAMCStatus('‚ùå Erreur g√©n√©ration PDF: ' + error.message, 'error');
      }
    }

    function showDownloadButtons(projectId) {
      const downloadContainer = document.getElementById('download-buttons');
      downloadContainer.innerHTML = '';
      downloadContainer.style.display = 'flex';
      
      // CORRECTION : Utiliser test-exam.pdf comme g√©n√©r√© par l'API
      const pdfBtn = document.createElement('a');
      pdfBtn.href = '/api/projects/' + projectId + '/pdf/test-exam.pdf';
      pdfBtn.target = '_blank';
      pdfBtn.className = 'btn-success';
      pdfBtn.textContent = 'üì• T√©l√©charger PDF';
      pdfBtn.style.padding = '10px 15px';
      pdfBtn.style.borderRadius = '8px';
      pdfBtn.style.textDecoration = 'none';
      pdfBtn.style.textAlign = 'center';
      
      // Bouton LaTeX
      const texBtn = document.createElement('button');
      texBtn.onclick = downloadLaTeX;
      texBtn.className = 'btn-primary';
      texBtn.textContent = 'üìÑ T√©l√©charger .tex';
      texBtn.style.padding = '10px 15px';
      texBtn.style.borderRadius = '8px';
      texBtn.style.border = 'none';
      texBtn.style.cursor = 'pointer';
      
      downloadContainer.appendChild(pdfBtn);
      downloadContainer.appendChild(texBtn);
    }

    function showAMCStatus(message, type = 'info') {
      const statusEl = document.getElementById('amc-status');
      statusEl.textContent = message;
      statusEl.style.color = 
        type === 'success' ? 'var(--success)' :
        type === 'error' ? 'var(--danger)' :
        type === 'loading' ? 'var(--primary)' : 'var(--text)';
    }
  </script>
</body>
</html>