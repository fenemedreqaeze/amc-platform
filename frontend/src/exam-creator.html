<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrÃ©ateur d'examen</title>
  <style>
    :root {
      --bg: #0f172a;         /* slate-900 */
      --card: #111827;       /* gray-900 */
      --muted: #1f2937;      /* gray-800 */
      --text: #e5e7eb;       /* gray-200 */
      --soft: #9ca3af;       /* gray-400 */
      --primary: #60a5fa;    /* blue-400 */
      --primary-600: #2563eb;/* blue-600 */
      --success: #22c55e;    /* green-500 */
      --danger: #ef4444;     /* red-500 */
      --danger-600: #dc2626; /* red-600 */
      --shadow: rgba(0,0,0,.35);
      
      /* Couleurs par matiÃ¨re */
      --maths: #e74c3c;      /* Rouge */
      --french: #3498db;     /* Bleu */
      --english: #9b59b6;    /* Violet */
      --history: #e67e22;    /* Orange */
      --geography: #27ae60;  /* Vert */
      --science: #f39c12;    /* Jaune */
      --other: #95a5a6;      /* Gris */
    }

    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; }

    .container { max-width: 980px; margin: 32px auto; padding: 0 16px; }

    h1 { font-size: 28px; font-weight: 700; margin: 0 0 20px; letter-spacing: .3px; }
    h3 { margin: 0 0 12px; font-size: 18px; }

    .exam-header {
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px var(--shadow);
    }

    .exam-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .exam-meta label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--soft);
    }

    select {
      width: 100%;
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }

    .question-card {
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: 14px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 6px 20px var(--shadow);
      transition: border-color 0.3s ease;
    }

    /* Styles par matiÃ¨re */
    .subject-maths { border-left: 4px solid var(--maths); }
    .subject-french { border-left: 4px solid var(--french); }
    .subject-english { border-left: 4px solid var(--english); }
    .subject-history { border-left: 4px solid var(--history); }
    .subject-geography { border-left: 4px solid var(--geography); }
    .subject-science { border-left: 4px solid var(--science); }
    .subject-other { border-left: 4px solid var(--other); }

    textarea, input[type="text"] {
      width: 100%;
      resize: vertical;
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 12px;
      outline: none;
    }

    .answer-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      padding: 10px;
      background: #0b1220;
      border: 1px solid var(--muted);
      border-radius: 10px;
    }

    .answer-row.correct-answer { border-color: var(--primary); box-shadow: inset 0 0 0 1px rgba(96,165,250,.35); }

    .answer-row input[type="text"] {
      background: transparent;
      border: none;
      border-left: 1px solid var(--muted);
      padding: 8px 10px;
      color: var(--text);
      outline: none;
    }

    .btn-primary, .btn-success, .btn-danger {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      transition: transform .04s ease, filter .08s ease, opacity .2s ease;
    }

    .btn-primary { background: var(--primary-600); }
    .btn-success { background: var(--success); color: #052e0f; }
    .btn-danger { background: var(--danger); }

    .btn-primary:active, .btn-success:active, .btn-danger:active { transform: translateY(1px); }
    .btn-danger:hover { filter: brightness(.95); }

    .actions { text-align: center; margin-top: 24px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

    .sub-actions { display: flex; gap: 8px; margin-top: 10px; }

    .note { color: var(--soft); font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>CrÃ©ateur d'examen</h1>

    <!-- En-tÃªte de l'examen avec mÃ©tadonnÃ©es -->
    <div class="exam-header">
      <input type="text" placeholder="Titre de l'examen" style="font-size: 1.3em; font-weight: bold; background: transparent; border: none; color: var(--text); outline: none; width: 100%;">
      <textarea placeholder="Description de l'examen..." rows="2" style="margin-top: 10px;"></textarea>
      
      <div class="exam-meta">
        <div>
          <label for="subject-select">ğŸ“š MatiÃ¨re</label>
          <select id="subject-select">
            <option value="maths">ğŸ“ MathÃ©matiques</option>
            <option value="french">ğŸ“– FranÃ§ais</option>
            <option value="english">ğŸ”¤ Anglais</option>
            <option value="history">ğŸ›ï¸ Histoire</option>
            <option value="geography">ğŸŒ GÃ©ographie</option>
            <option value="science">ğŸ”¬ Sciences</option>
            <option value="other">ğŸ“š Autre matiÃ¨re</option>
          </select>
        </div>
        <div>
          <label for="exam-difficulty">ğŸ¯ Niveau</label>
          <select id="exam-difficulty">
            <option value="easy">ğŸŸ¢ Facile</option>
            <option value="medium">ğŸŸ¡ Moyen</option>
            <option value="hard">ğŸ”´ Difficile</option>
          </select>
        </div>
      </div>
    </div>

    <div id="questions-container"></div>

    <!-- Boutons d'action -->
    <div class="actions">
      <button type="button" class="btn-success" onclick="addQuestion()">â• Ajouter une Question</button>
      <button type="button" class="btn-primary" onclick="saveExam()">ğŸ’¾ Sauvegarder l'Examen</button>
      <button type="button" class="btn-primary" onclick="goBack()">â† Retour Ã  l'accueil</button>
    </div>

    <!-- Section AMC - GÃ©nÃ©ration LaTeX & PDF -->
    <div class="exam-header" style="margin-top: 30px;">
      <h3>ğŸ”„ GÃ©nÃ©ration AMC</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
        <div>
          <label for="n-copies">Nombre de copies</label>
          <input type="number" id="n-copies" value="1" min="1" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--muted); background: #0b1220; color: var(--text);">
        </div>
        <div>
          <label for="project-id">ID Projet</label>
          <input type="text" id="project-id" readonly style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--muted); background: #0b1220; color: var(--soft);">
        </div>
      </div>

      <div class="actions" style="margin-top: 20px;">
        <button type="button" class="btn-primary" onclick="generateLaTeX()">ğŸ“„ GÃ©nÃ©rer le LaTeX</button>
        <button type="button" class="btn-primary" onclick="prepareExam()">ğŸ”„ PrÃ©parer l'examen</button>
        <button type="button" class="btn-primary" onclick="compilePDF()">ğŸ“¦ Compiler le PDF</button>
        <button type="button" class="btn-success" onclick="downloadPDF()">â¬‡ï¸ TÃ©lÃ©charger PDF</button>
      </div>

      <div id="amc-status" style="margin-top: 15px; padding: 12px; border-radius: 10px; background: #0b1220; border: 1px solid var(--muted);"></div>
    </div>



    <p class="note">AstuceÂ : marque la bonne rÃ©ponse en cochant le bouton radio correspondant. Tu peux ajouter/supprimer des rÃ©ponses librement.</p>
  </div>

  <script>
    let questionCount = 0;
    let currentSubject = 'maths';

    function updateQuestionStyles() {
      document.querySelectorAll('.question-card').forEach(card => {
        // Retirer toutes les classes de matiÃ¨re
        card.classList.remove('subject-maths', 'subject-french', 'subject-english', 'subject-history', 'subject-geography', 'subject-science', 'subject-other');
        // Ajouter la classe de matiÃ¨re actuelle
        card.classList.add(`subject-${currentSubject}`);
      });
    }

    function addQuestion() {
      questionCount++;
      const questionsContainer = document.getElementById('questions-container');

      const questionDiv = document.createElement('div');
      questionDiv.className = `question-card subject-${currentSubject}`;
      questionDiv.id = `question-${questionCount}`;
      questionDiv.innerHTML = `
        <h3>Question ${questionCount}</h3>
        <textarea placeholder="Ã‰noncÃ© de la question..." rows="3"></textarea>

        <div class="answer-row correct-answer">
          <input type="radio" name="correct-${questionCount}" checked>
          <input type="text" placeholder="RÃ©ponse correcte" style="flex: 1;">
          <button type="button" class="btn-danger answer-remove">âœ•</button>
        </div>

        <div class="answer-row">
          <input type="radio" name="correct-${questionCount}">
          <input type="text" placeholder="Mauvaise rÃ©ponse" style="flex: 1;">
          <button type="button" class="btn-danger answer-remove">âœ•</button>
        </div>

        <div class="sub-actions">
          <button type="button" class="btn-success add-answer-btn" data-id="${questionCount}">â• Ajouter une rÃ©ponse</button>
          <button type="button" class="btn-danger remove-question-btn" data-id="${questionCount}">ğŸ—‘ï¸ Supprimer cette question</button>
        </div>
      `;

      questionsContainer.appendChild(questionDiv);

      // === Ã‰VÃ‰NEMENTS SPÃ‰CIFIQUES Ã€ CETTE QUESTION ===

      // 1) Ajouter une rÃ©ponse
      const addBtn = questionDiv.querySelector('.add-answer-btn');
      addBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        addAnswer(this.getAttribute('data-id'));
      });

      // 2) Supprimer la question (un seul handler, pas de handler gÃ©nÃ©rique)
      const removeBtn = questionDiv.querySelector('.remove-question-btn');
      removeBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        removeQuestion(this.getAttribute('data-id'));
      });

      // 3) Supprimer une rÃ©ponse (ne cible QUE les boutons de ligne-rÃ©ponse)
      const answerDeleteBtns = questionDiv.querySelectorAll('.answer-remove');
      answerDeleteBtns.forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.stopPropagation();
          this.parentElement.remove();
        });
      });

      // 4) Styling visuel de la bonne rÃ©ponse
      const radios = questionDiv.querySelectorAll(`input[type="radio"][name="correct-${questionCount}"]`);
      radios.forEach(r => {
        r.addEventListener('change', () => {
          questionDiv.querySelectorAll('.answer-row').forEach(row => row.classList.remove('correct-answer'));
          const row = r.closest('.answer-row');
          if (row) row.classList.add('correct-answer');
        });
      });
    }

    function addAnswer(questionId) {
      const question = document.getElementById(`question-${questionId}`);
      if (!question) return;

      const newAnswer = document.createElement('div');
      newAnswer.className = 'answer-row';
      newAnswer.innerHTML = `
        <input type="radio" name="correct-${questionId}">
        <input type="text" placeholder="Nouvelle rÃ©ponse" style="flex: 1;">
        <button type="button" class="btn-danger answer-remove">âœ•</button>
      `;

      // Supprimer cette rÃ©ponse
      newAnswer.querySelector('.answer-remove').addEventListener('click', function (e) {
        e.stopPropagation();
        this.parentElement.remove();
      });

      // Mettre en surbrillance si cochÃ©e
      const radio = newAnswer.querySelector('input[type="radio"]');
      radio.addEventListener('change', () => {
        question.querySelectorAll('.answer-row').forEach(row => row.classList.remove('correct-answer'));
        newAnswer.classList.add('correct-answer');
      });

      // InsÃ©rer juste avant les sous-actions (boutons Ajouter/Supprimer)
      const subActions = question.querySelector('.sub-actions');
      question.insertBefore(newAnswer, subActions);
    }

    function removeQuestion(questionId) {
      const node = document.getElementById(`question-${questionId}`);
      if (node) node.remove();
    }

    function saveExam() {
      const subject = document.getElementById('subject-select');
      const difficulty = document.getElementById('exam-difficulty');
      const title = document.querySelector('input[placeholder*="Titre"]').value || 'Sans titre';
      const subjectText = subject.options[subject.selectedIndex].text;
      const difficultyText = difficulty.options[difficulty.selectedIndex].text;
      
      // Esquisse de sÃ©rialisation (pour plus tard)
      const payload = { 
        title,
        subject: currentSubject,
        difficulty: difficulty.value,
        questions: [] 
      };
      
      document.querySelectorAll('.question-card').forEach((qCard, idx) => {
        const statement = qCard.querySelector('textarea')?.value || '';
        const answers = [];
        const name = `correct-${idx + 1}`;
        const correctIndex = Array.from(qCard.querySelectorAll(`input[type="radio"][name="${name}"]`)).findIndex(r => r.checked);
        qCard.querySelectorAll('.answer-row').forEach((row) => {
          const text = row.querySelector('input[type="text"]').value || '';
          answers.push(text);
        });
        payload.questions.push({ statement, answers, correctIndex });
      });

      alert(`ğŸ‰ Examen "${title}" sauvegardÃ© !\nğŸ“š MatiÃ¨re: ${subjectText}\nğŸ¯ Niveau: ${difficultyText}`);
      console.log('Exam payload =>', payload);
    }

    function goBack() {
      window.location.href = '/';
    }

    // DÃ©marrage quand le DOM est prÃªt
    document.addEventListener('DOMContentLoaded', () => {
      addQuestion();
      
      // GÃ©rer le changement de matiÃ¨re
      document.getElementById('subject-select').addEventListener('change', function(e) {
        currentSubject = e.target.value;
        updateQuestionStyles();
      });
    });
    
document.addEventListener('DOMContentLoaded', () => {
  const subjectSel = document.getElementById('subject-select');
  if (subjectSel) {
    currentSubject = subjectSel.value || 'other';
    subjectSel.addEventListener('change', () => {
      currentSubject = subjectSel.value || 'other';
      // (optionnel) adapter le thÃ¨me/classe CSS selon la matiÃ¨re ici
    });
  }
});

// === INTÃ‰GRATION AMC API ===
let currentProjectId = null;

// CrÃ©er un projet AMC
async function createAMCProject() {
    try {
        showAMCStatus('ğŸ”„ CrÃ©ation du projet...', 'loading');
        
        const response = await fetch('/api/projects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        currentProjectId = data.project_id;
        document.getElementById('project-id').value = currentProjectId;
        showAMCStatus('âœ… Projet crÃ©Ã©: ' + currentProjectId, 'success');
        return currentProjectId;
        
    } catch (error) {
        showAMCStatus('âŒ Erreur crÃ©ation projet: ' + error.message, 'error');
        return null;
    }
}

// GÃ©nÃ©rer le code LaTeX Ã  partir des questions
function generateLaTeX() {
    const title = document.querySelector('input[placeholder*="Titre"]').value || 'Examen Sans Titre';
    const subject = document.getElementById('subject-select').options[document.getElementById('subject-select').selectedIndex].text;
    
    let latexContent = `\\documentclass[a4paper,11pt]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T1]{fontenc}
\\usepackage[francais]{babel}
\\usepackage{amc}

\\title{${title}}
\\author{${subject}}
\\date{\\\\today}

\\begin{document}
\\maketitle

\\begin{questions}`;

    // Ajouter chaque question au LaTeX
    document.querySelectorAll('.question-card').forEach((qCard, index) => {
        const questionText = qCard.querySelector('textarea').value || `Question ${index + 1}`;
        const answers = [];
        let correctAnswerIndex = -1;
        
        // RÃ©cupÃ©rer les rÃ©ponses et identifier la correcte
        qCard.querySelectorAll('.answer-row').forEach((row, ansIndex) => {
            const answerText = row.querySelector('input[type="text"]').value || `RÃ©ponse ${ansIndex + 1}`;
            const isCorrect = row.querySelector('input[type="radio"]').checked;
            answers.push(answerText);
            if (isCorrect) correctAnswerIndex = ansIndex;
        });

        if (answers.length > 0 && correctAnswerIndex >= 0) {
            latexContent += `\n\n\\question{${questionText}}`;
            answers.forEach((answer, i) => {
                if (i === correctAnswerIndex) {
                    latexContent += `\n\\bonne{${answer}}`;
                } else {
                    latexContent += `\n\\mauvaise{${answer}}`;
                }
            });
        }
    });

    latexContent += `\n\n\\end{questions}\n\\end{document}`;
    
    // Afficher le LaTeX gÃ©nÃ©rÃ©
    showAMCStatus('ğŸ“„ LaTeX gÃ©nÃ©rÃ© avec succÃ¨s!', 'success');
    console.log('LaTeX gÃ©nÃ©rÃ©:', latexContent);
    
    // TÃ©lÃ©charger le fichier .tex
    downloadLaTeXFile(latexContent, title);
    
    return latexContent;
}

// TÃ©lÃ©charger le fichier LaTeX
function downloadLaTeXFile(content, title) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-z0-9]/gi, '_')}.tex`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Upload et prÃ©paration de l'examen
async function prepareExam() {
    if (!currentProjectId) {
        const projectId = await createAMCProject();
        if (!projectId) return;
    }
    
    showAMCStatus('ğŸ”„ PrÃ©paration de l\'examen...', 'loading');
    
    // Ici vous devrez uploader le fichier .tex gÃ©nÃ©rÃ©
    // Pour l'instant, on simule avec un fichier existant
    try {
        const nCopies = document.getElementById('n-copies').value || 1;
        const response = await fetch(`/api/projects/${currentProjectId}/prepare`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tex_filename: 'exam.tex', // Ã€ adapter
                n_copies: parseInt(nCopies)
            })
        });
        
        const result = await response.json();
        showAMCStatus('âœ… Examen prÃ©parÃ©! ' + result.log, 'success');
        
    } catch (error) {
        showAMCStatus('âŒ Erreur prÃ©paration: ' + error.message, 'error');
    }
}

// Compiler le PDF
async function compilePDF() {
    if (!currentProjectId) {
        showAMCStatus('âŒ CrÃ©ez d\'abord un projet', 'error');
        return;
    }
    
    showAMCStatus('ğŸ”„ Compilation PDF...', 'loading');
    
    try {
        const response = await fetch(`/api/projects/${currentProjectId}/compile`, {
            method: 'POST'
        });
        
        const result = await response.json();
        showAMCStatus('âœ… PDF compilÃ©! ' + result.log, 'success');
        
    } catch (error) {
        showAMCStatus('âŒ Erreur compilation: ' + error.message, 'error');
    }
}

// TÃ©lÃ©charger le PDF
async function downloadPDF() {
    if (!currentProjectId) {
        showAMCStatus('âŒ Aucun projet actif', 'error');
        return;
    }
    
    try {
        // Ouvrir le PDF dans un nouvel onglet
        window.open(`/api/projects/${currentProjectId}/pdf/calage.pdf`, '_blank');
        showAMCStatus('ğŸ“„ Ouverture du PDF...', 'success');
        
    } catch (error) {
        showAMCStatus('âŒ Erreur tÃ©lÃ©chargement: ' + error.message, 'error');
    }
}

// Afficher le statut AMC
function showAMCStatus(message, type = 'info') {
    const statusEl = document.getElementById('amc-status');
    statusEl.textContent = message;
    statusEl.style.color = 
        type === 'success' ? 'var(--success)' :
        type === 'error' ? 'var(--danger)' :
        type === 'loading' ? 'var(--primary)' : 'var(--text)';
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    // CrÃ©er un projet AMC au dÃ©marrage
    setTimeout(() => createAMCProject(), 1000);
});

  </script>
</body>
</html>